<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paint Shop App - SaaS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'IBM Plex Sans Thai', 'sans-serif'], 
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                        'slide-down': 'slideDown 0.6s ease-out forwards',
                        'pop-in': 'popIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'float': 'float 3s ease-in-out infinite',
                    }
                },
            },
        }
    </script>
    
    <!-- Google Fonts: Inter & IBM Plex Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@100;200;300;400;500;600;700&family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: "Inter", "IBM Plex Sans Thai", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Animations */
        @keyframes shine {
            100% { left: 125%; }
        }
        .animate-shine {
            animation: shine 1s;
        }
        
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Pulse animation for camera record button */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
        .camera-btn-pulse {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-[#1e3a8a] font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- Global Settings ---
        // ⚠️ นำ Web App URL ของคุณมาใส่ตรงนี้ ⚠️
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz2sgYa1un0MlGBR1JzCCblHyXq8suF5WC68uAVJqvjvosFvPYM_p5OlEhbjNmICvI/exec"; 

        // --- Helper Function สำหรับแปลงลิงก์ Google Drive เป็น Direct Image Link ---
        const getDisplayImageUrl = (url) => {
            if (!url) return null;
            if (url.startsWith('data:image')) return url; // ถ้าเป็น Base64 ให้ใช้ได้เลย
            // ตรวจจับ ID รูปจาก Google Drive URL และแปลงเป็น Direct Link
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            }
            return url;
        };

        // --- Icons Components (SVG) ---
        const Icon = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const Icons = {
            Search: (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>,
            Plus: (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Phone: (props) => <Icon {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></Icon>,
            User: (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            Users: (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>,
            Brush: (props) => <Icon {...props}><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2.5 2.24 0 .46.62.8 1 .8a2.49 2.49 0 0 0 2.5-2.5c0-.56.42-1.03.98-1.06 1.12-.06 2.16-1.15 2.52-2.27Z"/><path d="M14 14.5c.9 2.44 3.5 3 3.5 3"/></Icon>,
            Camera: (props) => <Icon {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>,
            X: (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Save: (props) => <Icon {...props}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></Icon>,
            ImageIcon: (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>,
            Trash2: (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
            ChevronRight: (props) => <Icon {...props}><path d="m9 18 6-6-6-6"/></Icon>,
            Home: (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
            Edit: (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>,
            SwitchCamera: (props) => <Icon {...props}><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><path d="m11 22 3-3-3-3"/><path d="m13 2-3 3 3 3"/></Icon>,
            LogOut: (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>,
            Lock: (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            Crown: (props) => <Icon {...props}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></Icon>,
            Zap: (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>,
            CheckCircle: (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>,
            AlertCircle: (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            DollarSign: (props) => <Icon {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>,
            Activity: (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></Icon>,
            Settings: (props) => <Icon {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>
        };

        // --- Packages Configuration ---
        const PACKAGES = {
            FREE: { id: 'FREE', name: 'Free', limit: 5, price: 'ฟรี', priceValue: 0, color: 'bg-blue-50 border-blue-200 text-[#1e3a8a]', badge: 'bg-gray-100 text-gray-700', icon: <Icons.User className="w-6 h-6" /> },
            PRO: { id: 'PRO', name: 'Pro', limit: 50, price: '299 ฿/เดือน', priceValue: 299, color: 'bg-orange-50 border-orange-300 text-orange-600', badge: 'bg-orange-500 text-white', icon: <Icons.Zap className="w-6 h-6" /> },
            PREMIUM: { id: 'PREMIUM', name: 'Premium', limit: 99999, price: '899 ฿/เดือน', priceValue: 899, color: 'bg-red-50 border-red-200 text-red-600', badge: 'bg-red-500 text-white', icon: <Icons.Crown className="w-6 h-6" /> }
        };

        // --- Auth Screen Component ---
        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [selectedPlan, setSelectedPlan] = useState('FREE');
            const [errorMsg, setErrorMsg] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setErrorMsg('');
                
                if (!username || !password) {
                    setErrorMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }

                if (WEB_APP_URL === "YOUR_WEB_APP_URL_HERE") {
                    setErrorMsg('กรุณาตั้งค่า WEB_APP_URL เพื่อเชื่อมต่อฐานข้อมูลก่อนใช้งาน');
                    return;
                }

                setIsSaving(true);
                try {
                    // ดึงข้อมูลผู้ใช้ทั้งหมดจาก Google Sheets
                    const res = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'readUsers' }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    const result = await res.json();
                    let usersDB = result.data || [];

                    // ถ้าระบบยังไม่มีใครเลย ให้สร้างแอดมินจำลองขึ้นมา 1 คน
                    if (usersDB.length === 0) {
                        usersDB = [{ id: 'admin1', username: 'admin', password: 'password', role: 'ADMIN', plan: 'PREMIUM' }];
                    }

                    if (isLogin) {
                        const user = usersDB.find(u => u.username === username && u.password === password);
                        if (user) {
                            onLogin(user);
                        } else {
                            setErrorMsg('ชื่อผู้ใช้ หรือ รหัสผ่าน ไม่ถูกต้อง');
                        }
                    } else {
                        const exists = usersDB.find(u => u.username === username);
                        if (exists) {
                            setErrorMsg('ชื่อผู้ใช้นี้มีในระบบแล้ว');
                        } else {
                            const newUser = { id: Date.now(), username, password, plan: selectedPlan, role: 'USER' };
                            
                            // ส่งข้อมูล Registration ไปเซฟลง Google Sheets โดยตรง
                            const saveRes = await fetch(WEB_APP_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'saveUser', ...newUser }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                            const saveResult = await saveRes.json();
                            if(saveResult.status !== 'success') throw new Error(saveResult.message);

                            onLogin(newUser);
                        }
                    }
                } catch (err) {
                    setErrorMsg('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้: ' + err.message);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-[#1e3a8a] to-[#2546a3] flex items-center justify-center p-6">
                    <div className="bg-white w-full max-w-md rounded-[32px] p-8 shadow-2xl animate-pop-in relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-orange-500"></div>
                        
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-50 rounded-2xl mx-auto flex items-center justify-center mb-4 border border-blue-100 shadow-sm">
                                <Icons.Brush className="w-8 h-8 text-[#1e3a8a]" />
                            </div>
                            <h1 className="text-2xl font-black text-[#1e3a8a] tracking-tight">Paint Store SaaS</h1>
                            <p className="text-blue-400 text-xs font-bold uppercase tracking-widest mt-1">
                                {isLogin ? 'เข้าสู่ระบบเพื่อจัดการข้อมูล' : 'ลงทะเบียนเพื่อเริ่มต้นใช้งาน'}
                            </p>
                        </div>

                        {errorMsg && (
                            <div className="mb-4 p-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold text-center border border-red-100 flex items-center justify-center gap-2">
                                <Icons.AlertCircle className="w-4 h-4" /> {errorMsg}
                            </div>
                        )}

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div className="group">
                                <div className="flex items-center bg-blue-50/50 border-2 border-blue-100 rounded-2xl px-4 py-3 focus-within:border-[#1e3a8a] focus-within:bg-white transition-all">
                                    <Icons.User className="w-5 h-5 text-blue-300 group-focus-within:text-[#1e3a8a] mr-3" />
                                    <input 
                                        type="text" placeholder="ชื่อผู้ใช้งาน (Username)" 
                                        className="w-full bg-transparent outline-none text-[#1e3a8a] font-semibold text-sm"
                                        value={username} onChange={e => setUsername(e.target.value)} disabled={isSaving}
                                    />
                                </div>
                            </div>
                            <div className="group">
                                <div className="flex items-center bg-blue-50/50 border-2 border-blue-100 rounded-2xl px-4 py-3 focus-within:border-[#1e3a8a] focus-within:bg-white transition-all">
                                    <Icons.Lock className="w-5 h-5 text-blue-300 group-focus-within:text-[#1e3a8a] mr-3" />
                                    <input 
                                        type="password" placeholder="รหัสผ่าน (Password)" 
                                        className="w-full bg-transparent outline-none text-[#1e3a8a] font-semibold text-sm"
                                        value={password} onChange={e => setPassword(e.target.value)} disabled={isSaving}
                                    />
                                </div>
                            </div>

                            {!isLogin && (
                                <div className="pt-4 pb-2 animate-fade-in-up">
                                    <p className="text-xs font-black text-[#1e3a8a] mb-3">เลือกแพ็กเกจของคุณ:</p>
                                    <div className="grid grid-cols-3 gap-2">
                                        {Object.values(PACKAGES).map(pkg => (
                                            <div 
                                                key={pkg.id} 
                                                onClick={() => !isSaving && setSelectedPlan(pkg.id)}
                                                className={`cursor-pointer rounded-xl p-3 border-2 text-center transition-all ${selectedPlan === pkg.id ? pkg.color + ' scale-105 shadow-md' : 'bg-white border-gray-100 opacity-60 hover:opacity-100'}`}
                                            >
                                                <div className="flex justify-center mb-1">{pkg.icon}</div>
                                                <p className="text-[10px] font-bold leading-tight">{pkg.name}</p>
                                                <p className="text-[9px] mt-1 opacity-80 font-semibold">{pkg.price}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <button type="submit" disabled={isSaving} className={`w-full bg-[#1e3a8a] text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-[#172554] hover:shadow-xl transition-all mt-6 flex justify-center items-center gap-2 ${isSaving ? 'opacity-80' : 'active:scale-95'}`}>
                                {isSaving ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : null}
                                {isSaving ? 'กำลังดำเนินการ...' : (isLogin ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก')}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <p className="text-xs text-blue-300 font-semibold">
                                {isLogin ? "ยังไม่มีบัญชีใช่หรือไม่? " : "มีบัญชีอยู่แล้ว? "}
                                <span 
                                    onClick={() => { if(!isSaving){ setIsLogin(!isLogin); setErrorMsg(''); } }}
                                    className="text-orange-500 font-bold cursor-pointer hover:underline"
                                >
                                    {isLogin ? "สมัครสมาชิกที่นี่" : "เข้าสู่ระบบเลย"}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Admin Dashboard Application ---
        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [allUsers, setAllUsers] = useState([]);
            const [activeTab, setActiveTab] = useState('overview'); // 'overview' | 'users'
            const [searchTerm, setSearchTerm] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            
            // Manage User Modal
            const [isUserModalOpen, setIsUserModalOpen] = useState(false);
            const [editingUserId, setEditingUserId] = useState(null);
            const [userForm, setUserForm] = useState({ username: '', password: '', role: 'USER', plan: 'FREE' });

            // ดึงรายชื่อ User จาก API ทันทีที่เปิด Admin Dashboard (ยกเลิก localStorage)
            useEffect(() => {
                const fetchUsers = async () => {
                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        try {
                            const res = await fetch(WEB_APP_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'readUsers' }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                            const result = await res.json();
                            if (result.status === 'success') {
                                setAllUsers(result.data || []);
                            }
                        } catch(e) {
                            console.error("ไม่สามารถโหลดรายชื่อผู้ใช้ได้", e);
                        }
                    }
                    setIsLoading(false);
                };
                fetchUsers();
            }, []);

            // Calc Stats
            const totalUsers = allUsers.length;
            const revenue = allUsers.reduce((sum, u) => sum + (PACKAGES[u.plan] ? PACKAGES[u.plan].priceValue : 0), 0);
            const activeProPrem = allUsers.filter(u => u.plan === 'PRO' || u.plan === 'PREMIUM').length;

            const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(searchTerm.toLowerCase()));

            const handleAddUserClick = () => {
                setUserForm({ username: '', password: '', role: 'USER', plan: 'FREE' });
                setEditingUserId(null);
                setIsUserModalOpen(true);
            };

            const handleEditUserClick = (user) => {
                setUserForm({ username: user.username, password: user.password, role: user.role || 'USER', plan: user.plan || 'FREE' });
                setEditingUserId(user.id || user.username);
                setIsUserModalOpen(true);
            };

            const handleDeleteUser = async (idOrUsername, e) => {
                e.stopPropagation();
                if (window.confirm('ต้องการลบบัญชีผู้ใช้นี้ใช่หรือไม่ ข้อมูลของเขาจะหายไปทั้งหมด?')) {
                    const prevUsers = [...allUsers];
                    setAllUsers(allUsers.filter(u => (u.id || u.username) !== idOrUsername));
                    
                    // ลบใน Backend
                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        try {
                            await fetch(WEB_APP_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'deleteUser', id: idOrUsername }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                        } catch (err) {
                            alert("ลบข้อมูลในเซิร์ฟเวอร์ไม่สำเร็จ");
                            setAllUsers(prevUsers);
                        }
                    }
                }
            };

            const handleSaveUser = async (e) => {
                e.preventDefault();
                if (!userForm.username || !userForm.password) return;

                setIsSaving(true);
                try {
                    let finalId = editingUserId || Date.now();
                    const payload = { action: 'saveUser', id: finalId, ...userForm };

                    // บันทึกไป Backend
                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        const res = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        const data = await res.json();
                        if (data.status !== 'success') throw new Error(data.message);
                    }

                    if (editingUserId) {
                        setAllUsers(allUsers.map(u => (u.id || u.username) === editingUserId ? { ...u, ...userForm } : u));
                    } else {
                        if (allUsers.find(u => u.username === userForm.username)) {
                            alert("ชื่อผู้ใช้นี้มีในระบบแล้ว");
                            setIsSaving(false);
                            return;
                        }
                        const newUser = { id: finalId, ...userForm };
                        setAllUsers([newUser, ...allUsers]);
                    }
                    setIsUserModalOpen(false);
                } catch(err) {
                    alert("บันทึกไม่สำเร็จ: " + err.message);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-[#1e3a8a] pb-24 relative overflow-hidden font-sans flex flex-col">
                    <div className="absolute top-0 left-0 w-full h-72 bg-gradient-to-b from-[#0f172a] via-[#1e293b] to-transparent z-0 shadow-xl opacity-90 transition-all duration-1000"></div>

                    {/* Admin Header */}
                    <div className="relative z-10 px-6 pt-10 pb-4 animate-slide-down opacity-0" style={{ animationDelay: '50ms' }}>
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-rose-500/20 backdrop-blur-md rounded-xl text-rose-400 border border-rose-500/30 shadow-inner">
                                    <Icons.Lock className="w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="text-white text-2xl font-black tracking-tight">Admin Panel</h1>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-gray-300 text-xs font-medium opacity-90">@{currentUser.username}</span>
                                        <span className="text-[9px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider bg-rose-500 text-white">ADMIN</span>
                                    </div>
                                </div>
                            </div>
                            <button onClick={onLogout} className="p-3 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors backdrop-blur-md border border-white/20">
                                <Icons.LogOut className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-black/20 p-1 rounded-2xl backdrop-blur-sm border border-white/10 relative">
                            <button 
                                onClick={() => setActiveTab('overview')} 
                                className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all z-10 ${activeTab === 'overview' ? 'bg-white text-[#0f172a] shadow-sm' : 'text-gray-300 hover:text-white'}`}
                            >
                                ภาพรวม (Overview)
                            </button>
                            <button 
                                onClick={() => setActiveTab('users')} 
                                className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all z-10 ${activeTab === 'users' ? 'bg-white text-[#0f172a] shadow-sm' : 'text-gray-300 hover:text-white'}`}
                            >
                                จัดการผู้ใช้ (Users)
                            </button>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="relative z-10 px-5 mt-4 space-y-4">
                        
                        {/* Tab 1: Overview */}
                        {activeTab === 'overview' && (
                            <div className="animate-fade-in-up space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition-shadow">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-blue-50 rounded-xl text-blue-500"><Icons.Users className="w-5 h-5" /></div>
                                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">ผู้ใช้ทั้งหมด</span>
                                        </div>
                                        <h2 className="text-3xl font-black text-[#1e3a8a]">{totalUsers}</h2>
                                    </div>
                                    <div className="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition-shadow">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-green-50 rounded-xl text-green-500"><Icons.DollarSign className="w-5 h-5" /></div>
                                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">รายได้/เดือน</span>
                                        </div>
                                        <h2 className="text-3xl font-black text-green-600">฿{revenue.toLocaleString()}</h2>
                                    </div>
                                </div>
                                <div className="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
                                    <div className="flex items-center gap-4">
                                        <div className="p-3 bg-orange-50 rounded-2xl text-orange-500"><Icons.Activity className="w-6 h-6" /></div>
                                        <div>
                                            <h3 className="text-sm font-bold text-[#1e3a8a]">แพ็กเกจระดับสูง (Pro/Premium)</h3>
                                            <p className="text-xs text-gray-400 mt-1 font-medium">ผู้ใช้ที่ชำระเงินในระบบ</p>
                                        </div>
                                    </div>
                                    <span className="text-2xl font-black text-orange-500">{activeProPrem}</span>
                                </div>
                            </div>
                        )}

                        {/* Tab 2: Users Management */}
                        {activeTab === 'users' && (
                            <div className="animate-fade-in-up space-y-4">
                                <div className="relative mb-2">
                                    <input
                                        type="text" placeholder="ค้นหาชื่อผู้ใช้..."
                                        className="w-full pl-12 pr-4 py-4 rounded-2xl border border-gray-100 shadow-sm bg-white text-[#1e3a8a] placeholder-blue-200 focus:ring-2 focus:ring-[#0f172a] outline-none text-sm font-medium transition-shadow"
                                        value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <Icons.Search className="absolute left-4 top-4 text-[#1e3a8a] w-5 h-5 opacity-40" />
                                </div>

                                {filteredUsers.map((user, index) => {
                                    const pkg = PACKAGES[user.plan] || PACKAGES.FREE;
                                    return (
                                        <div key={user.id || user.username} onClick={() => handleEditUserClick(user)} className="group bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex gap-4 items-center relative overflow-hidden transition-all duration-300 hover:shadow-md hover:-translate-y-1 cursor-pointer active:scale-[0.98]">
                                            <div className={`absolute left-0 top-4 bottom-4 w-1.5 rounded-r-full shadow-sm ${user.role === 'ADMIN' ? 'bg-rose-500' : 'bg-[#1e3a8a]'}`}></div>
                                            
                                            <div className="w-12 h-12 bg-gray-50 rounded-full flex-shrink-0 flex items-center justify-center border border-gray-100">
                                                {user.role === 'ADMIN' ? <Icons.Lock className="w-5 h-5 text-rose-500" /> : <Icons.User className="w-5 h-5 text-[#1e3a8a]" />}
                                            </div>

                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="font-bold text-[#1e3a8a] text-[15px] truncate">{user.username}</h3>
                                                    {user.role === 'ADMIN' && <span className="bg-rose-100 text-rose-600 px-2 py-0.5 rounded text-[8px] font-black tracking-wider">ADMIN</span>}
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider ${pkg.badge}`}>{pkg.name}</span>
                                                    <button onClick={(e) => handleDeleteUser(user.id || user.username, e)} className="p-1.5 rounded-full text-red-300 hover:text-red-500 hover:bg-red-50 transition-colors z-20">
                                                        <Icons.Trash2 className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </div>
                                            <Icons.ChevronRight className="text-gray-300 w-5 h-5 group-hover:text-[#1e3a8a] group-hover:translate-x-1 transition-all" />
                                        </div>
                                    );
                                })}

                                {/* Add User FAB */}
                                <div className="fixed bottom-6 left-0 w-full px-6 z-20 flex justify-center animate-pop-in">
                                    <button onClick={handleAddUserClick} className="flex items-center gap-3 bg-[#0f172a] text-white px-8 py-4 rounded-full shadow-2xl hover:bg-black active:scale-95 transition-all ring-4 ring-white/10 group">
                                        <div className="bg-rose-500 p-1 rounded-full shadow-inner group-hover:rotate-90 transition-transform"><Icons.Plus className="w-4 h-4 text-white" /></div>
                                        <span className="font-bold text-sm tracking-widest uppercase">เพิ่มผู้ใช้งาน</span>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Admin Edit User Modal */}
                    {isUserModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-[#0f172a]/80 backdrop-blur-sm transition-all duration-300" onClick={(e) => { if (e.target === e.currentTarget && !isSaving) setIsUserModalOpen(false); }}>
                            <div className="bg-white w-full sm:max-w-md h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-[40px] sm:rounded-3xl flex flex-col overflow-hidden shadow-2xl relative animate-pop-in">
                                
                                <div className="bg-white text-[#1e3a8a] p-8 pb-4 rounded-b-3xl z-10 relative shadow-sm">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h2 className="text-2xl font-black tracking-tight">{editingUserId ? 'แก้ไขผู้ใช้' : 'เพิ่มผู้ใช้ใหม่'}</h2>
                                            <p className="text-blue-300 text-xs font-bold uppercase mt-1 tracking-widest">User Management</p>
                                        </div>
                                        <button disabled={isSaving} onClick={() => setIsUserModalOpen(false)} className="bg-gray-100 p-2.5 rounded-full hover:bg-red-50 hover:text-red-500 hover:scale-110 transition-all"><Icons.X className="w-6 h-6" /></button>
                                    </div>
                                </div>

                                <form onSubmit={handleSaveUser} className="flex-1 overflow-y-auto p-8 space-y-6 bg-white no-scrollbar">
                                    <div className="space-y-4">
                                        <div className="flex items-center border-2 border-gray-100 bg-gray-50 rounded-2xl px-5 py-4 focus-within:border-[#0f172a] focus-within:bg-white transition-all">
                                            <Icons.User className="text-gray-400 w-5 h-5 mr-4" />
                                            <div className="flex-1">
                                                <label className="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-1">Username</label>
                                                <input required type="text" className="w-full outline-none text-[#1e3a8a] font-bold bg-transparent" value={userForm.username} onChange={e => setUserForm({...userForm, username: e.target.value})} disabled={!!editingUserId || isSaving} />
                                            </div>
                                        </div>
                                        <div className="flex items-center border-2 border-gray-100 bg-gray-50 rounded-2xl px-5 py-4 focus-within:border-[#0f172a] focus-within:bg-white transition-all">
                                            <Icons.Lock className="text-gray-400 w-5 h-5 mr-4" />
                                            <div className="flex-1">
                                                <label className="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-1">Password</label>
                                                <input required type="text" className="w-full outline-none text-[#1e3a8a] font-bold bg-transparent" value={userForm.password} onChange={e => setUserForm({...userForm, password: e.target.value})} disabled={isSaving} />
                                            </div>
                                        </div>
                                        
                                        <div className="pt-2">
                                            <label className="block text-xs font-black uppercase tracking-widest text-[#1e3a8a] mb-3">บทบาท (Role)</label>
                                            <div className="flex gap-2">
                                                <button type="button" disabled={isSaving} onClick={() => setUserForm({...userForm, role: 'USER'})} className={`flex-1 py-3 rounded-xl text-xs font-bold border-2 transition-all ${userForm.role === 'USER' ? 'border-[#1e3a8a] bg-blue-50 text-[#1e3a8a]' : 'border-gray-100 text-gray-400'}`}>USER</button>
                                                <button type="button" disabled={isSaving} onClick={() => setUserForm({...userForm, role: 'ADMIN'})} className={`flex-1 py-3 rounded-xl text-xs font-bold border-2 transition-all ${userForm.role === 'ADMIN' ? 'border-rose-500 bg-rose-50 text-rose-600' : 'border-gray-100 text-gray-400'}`}>ADMIN</button>
                                            </div>
                                        </div>

                                        {userForm.role !== 'ADMIN' && (
                                            <div className="pt-2">
                                                <label className="block text-xs font-black uppercase tracking-widest text-[#1e3a8a] mb-3">แพ็กเกจ (Plan)</label>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {Object.values(PACKAGES).map(pkg => (
                                                        <div key={pkg.id} onClick={() => !isSaving && setUserForm({...userForm, plan: pkg.id})} className={`cursor-pointer rounded-xl p-3 border-2 text-center transition-all ${userForm.plan === pkg.id ? pkg.color + ' shadow-md' : 'border-gray-100 opacity-60'}`}>
                                                            <div className="flex justify-center mb-1">{pkg.icon}</div>
                                                            <p className="text-[10px] font-bold">{pkg.name}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </form>

                                <div className="p-6 bg-white border-t border-gray-100">
                                    <button disabled={isSaving} onClick={handleSaveUser} className={`w-full bg-[#0f172a] text-white font-black py-4 rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3 text-sm tracking-[0.2em] uppercase ${isSaving ? 'opacity-80' : 'active:translate-y-[2px]'}`}>
                                        {isSaving ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.Save className="w-5 h-5" />} 
                                        <span>{isSaving ? 'กำลังบันทึก...' : (editingUserId ? 'บันทึกการแก้ไข' : 'สร้างบัญชีผู้ใช้')}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main User Dashboard Application ---
        const Dashboard = ({ currentUser, onLogout }) => {
            const [customers, setCustomers] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            // ดึงข้อมูลลูกค้าจาก API เท่านั้น (ยกเลิก localStorage)
            useEffect(() => {
                const fetchData = async () => {
                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        setIsLoadingData(true);
                        try {
                            const response = await fetch(WEB_APP_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'read', username: currentUser.username }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                            const result = await response.json();
                            if (result.status === 'success') {
                                setCustomers(result.data || []);
                            }
                        } catch (err) {
                            console.error("Fetch error:", err);
                        } finally {
                            setIsLoadingData(false);
                        }
                    }
                };
                fetchData();
            }, [currentUser.username]);

            const currentPackage = PACKAGES[currentUser.plan] || PACKAGES.FREE;
            const usageCount = customers.length;
            const canAddMore = usageCount < currentPackage.limit;

            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null); 
            const [selectedImage, setSelectedImage] = useState(null);
            const [showQuotaWarning, setShowQuotaWarning] = useState(false);
            
            // --- Line Browser Detection ---
            const [isLineBrowser, setIsLineBrowser] = useState(false);
            
            // --- Camera State Management ---
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [facingMode, setFacingMode] = useState('environment');
            const [cameraError, setCameraError] = useState(null);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null); 
            
            const [formData, setFormData] = useState({ name: '', phone: '', technician: '', note: '' });

            const galleryInputRef = useRef(null);
            const nativeCameraInputRef = useRef(null);

            useEffect(() => {
                if (/Line/i.test(navigator.userAgent)) setIsLineBrowser(true);
            }, []);

            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const fileReader = new FileReader();
                    fileReader.readAsDataURL(file);
                    fileReader.onload = () => resolve(fileReader.result);
                    fileReader.onerror = (error) => reject(error);
                });
            };

            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.phone.includes(searchTerm) ||
                (customer.technician && customer.technician.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const base64 = await convertToBase64(file);
                        setSelectedImage(base64);
                    } catch (error) {
                        console.error("Error converting image:", error);
                    }
                }
                e.target.value = ''; 
            };

            // --- Camera Functions ---
            const stopMediaTracks = useCallback(() => {
                if (streamRef.current) {
                    const tracks = streamRef.current.getTracks();
                    tracks.forEach(track => { track.stop(); track.enabled = false; });
                    streamRef.current = null;
                }
                if (videoRef.current) videoRef.current.srcObject = null;
            }, []);

            const initCamera = useCallback(async () => {
                setCameraError(null);
                stopMediaTracks();
                await new Promise(r => setTimeout(r, 100));
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode }, audio: false });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => videoRef.current.play().catch(e => console.warn(e));
                    }
                } catch (err) {
                    setCameraError("ไม่สามารถเปิดกล้องได้ โปรดลองใช้กล้องระบบแทน");
                }
            }, [facingMode, stopMediaTracks]);

            useEffect(() => {
                let mounted = true;
                if (isCameraActive) initCamera();
                else stopMediaTracks();
                return () => { mounted = false; stopMediaTracks(); };
            }, [isCameraActive, initCamera, stopMediaTracks]);

            const capturePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas && video.videoWidth > 0) {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    if (facingMode === 'user') {
                        context.translate(canvas.width, 0);
                        context.scale(-1, 1);
                    }
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    setSelectedImage(canvas.toDataURL('image/jpeg', 0.85));
                    setIsCameraActive(false); 
                }
            };

            const toggleCameraFacing = () => {
                stopMediaTracks();
                setFacingMode(prev => prev === 'environment' ? 'user' : 'environment');
            };

            const triggerGallery = () => galleryInputRef.current && galleryInputRef.current.click();
            const triggerNativeCamera = () => {
                if (nativeCameraInputRef.current) {
                     nativeCameraInputRef.current.click();
                     setIsCameraActive(false);
                     setCameraError(null);
                }
            };
            const handleOpenExternal = () => window.location.href = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'openExternalBrowser=1';

            const handleAddNew = () => {
                if (!canAddMore) {
                    setShowQuotaWarning(true);
                    return;
                }
                setFormData({ name: '', phone: '', technician: '', note: '' });
                setSelectedImage(null);
                setEditingId(null);
                setIsModalOpen(true);
            };

            const handleEdit = (customer) => {
                setFormData({ name: customer.name, phone: customer.phone, technician: customer.technician || '', note: customer.note || '' });
                setSelectedImage(customer.image);
                setEditingId(customer.id);
                setIsModalOpen(true);
            };

            const handleDelete = async (id, e) => {
                e.stopPropagation(); 
                if(window.confirm('ต้องการลบข้อมูลนี้ใช่หรือไม่?')) {
                    const prevCustomers = [...customers];
                    setCustomers(customers.filter(c => c.id !== id));
                    if (editingId === id) setIsModalOpen(false); 

                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        try {
                            const response = await fetch(WEB_APP_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'delete', id: id, username: currentUser.username }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                            const result = await response.json();
                            if (result.status !== 'success') throw new Error(result.message);
                        } catch(err) {
                            alert("ลบข้อมูลบนเซิร์ฟเวอร์ไม่สำเร็จ: " + err.message);
                            setCustomers(prevCustomers); // นำข้อมูลกลับมาถ้าลบไม่สำเร็จ
                        }
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.phone) return;
                if (!editingId && !canAddMore) return; 

                setIsSaving(true);
                const dateStr = new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });

                try {
                    const payload = {
                        action: 'save',
                        username: currentUser.username,
                        editingId: editingId,
                        date: dateStr,
                        ...formData,
                        image: selectedImage
                    };

                    let finalImage = selectedImage;
                    let finalId = editingId || Date.now();

                    // ส่ง API ไปยัง Google Apps Script (ถ้ามีการตั้งค่า URL)
                    if (WEB_APP_URL && WEB_APP_URL !== "YOUR_WEB_APP_URL_HERE") {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        const result = await response.json();
                        
                        if (result.status !== 'success') {
                            throw new Error(result.message);
                        }
                        
                        finalImage = result.imageUrl || selectedImage;
                        finalId = result.id || finalId;
                    }

                    if (editingId) {
                        setCustomers(customers.map(c => c.id === editingId ? { ...c, ...formData, image: finalImage } : c));
                    } else {
                        const newCustomer = { id: finalId, ...formData, date: dateStr, image: finalImage };
                        setCustomers([newCustomer, ...customers]);
                    }
                    
                    setIsModalOpen(false);
                    setIsCameraActive(false); 

                } catch (error) {
                    alert("เกิดข้อผิดพลาดในการบันทึกลงเซิร์ฟเวอร์: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const closeCamera = () => {
                setIsCameraActive(false);
                setCameraError(null);
            };

            return (
                <div className="min-h-screen bg-gray-50 text-[#1e3a8a] pb-24 relative overflow-hidden font-sans flex flex-col">
                    
                    {/* LINE Browser Warning Banner */}
                    {isLineBrowser && (
                        <div className="relative z-50 bg-orange-500 text-white px-4 py-3 flex justify-between items-center shadow-md animate-slide-down">
                            <div className="flex items-center gap-2 flex-1">
                                <Icons.Camera className="w-5 h-5 flex-shrink-0" />
                                <span className="text-xs font-bold leading-tight">เพื่อใช้งานกล้อง แนะนำให้เปิดในเบราว์เซอร์ปกติ</span>
                            </div>
                            <button onClick={handleOpenExternal} className="ml-3 bg-white text-orange-600 px-3 py-1.5 rounded-full text-[10px] font-bold active:scale-95 transition-transform shadow-sm whitespace-nowrap">
                                เปิด Chrome/Safari
                            </button>
                        </div>
                    )}

                    {/* Background Decor */}
                    <div className="absolute top-0 left-0 w-full h-72 bg-gradient-to-b from-[#1e3a8a] via-[#2546a3] to-transparent z-0 shadow-xl opacity-90 transition-all duration-1000"></div>

                    {/* Header */}
                    <div className="relative z-10 px-6 pt-10 pb-4 animate-slide-down opacity-0" style={{ animationDelay: '50ms' }}>
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-white/10 backdrop-blur-md rounded-xl text-white border border-white/20 shadow-inner">
                                    <Icons.Home className="w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="text-white text-2xl font-black tracking-tight">Paint Store</h1>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-blue-100 text-xs font-medium opacity-90">@{currentUser.username}</span>
                                        <span className={`text-[9px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider ${currentPackage.badge}`}>
                                            {currentPackage.name}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <button onClick={onLogout} className="p-3 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors backdrop-blur-md border border-white/20">
                                <Icons.LogOut className="w-5 h-5" />
                            </button>
                        </div>
                        
                        {/* Quota Bar */}
                        <div className="mb-6 bg-black/20 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-white text-xs font-bold">โควต้าการใช้งาน</span>
                                <span className="text-white text-xs font-black">{usageCount} / {currentPackage.limit > 1000 ? 'ไม่จำกัด' : currentPackage.limit}</span>
                            </div>
                            <div className="w-full bg-white/20 rounded-full h-1.5">
                                <div className={`h-1.5 rounded-full ${usageCount >= currentPackage.limit ? 'bg-red-400' : 'bg-green-400'}`} style={{ width: `${currentPackage.limit > 1000 ? 100 : Math.min((usageCount/currentPackage.limit)*100, 100)}%` }}></div>
                            </div>
                        </div>

                        {/* Search Bar */}
                        <div className="relative transform translate-y-2 animate-fade-in-up opacity-0" style={{ animationDelay: '150ms' }}>
                            <input
                                type="text" placeholder="ค้นหาชื่อ, เบอร์โทร..."
                                className="w-full pl-12 pr-4 py-4 rounded-2xl border-none shadow-[0_8px_20px_-5px_rgba(0,0,0,0.15)] bg-white text-[#1e3a8a] placeholder-blue-300 focus:ring-2 focus:ring-orange-500 outline-none text-sm font-medium transition-shadow hover:shadow-lg"
                                value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <Icons.Search className="absolute left-4 top-4 text-[#1e3a8a] w-5 h-5 opacity-40" />
                        </div>
                    </div>

                    {/* List Container */}
                    <div className="relative z-10 px-5 mt-10 space-y-4">
                        <div className="flex justify-between items-end px-1 mb-2 animate-fade-in-up opacity-0" style={{ animationDelay: '250ms' }}>
                            <span className="text-[#1e3a8a] font-bold text-lg">รายการล่าสุด</span>
                            <span className="text-[#1e3a8a] text-[10px] font-bold bg-blue-50 px-3 py-1 rounded-full border border-blue-100 uppercase tracking-tighter opacity-80">
                                {filteredCustomers.length} รายการ
                            </span>
                        </div>

                        {isLoadingData ? (
                            <div className="text-center py-20 animate-pulse">
                                <div className="w-10 h-10 border-4 border-blue-200 border-t-[#1e3a8a] rounded-full animate-spin mx-auto mb-4"></div>
                                <p className="text-[#1e3a8a] text-sm font-bold opacity-70">กำลังซิงค์ข้อมูล...</p>
                            </div>
                        ) : filteredCustomers.length === 0 ? (
                            <div className="text-center py-20 animate-pop-in opacity-0" style={{ animationDelay: '300ms' }}>
                                <div className="bg-white p-5 rounded-3xl inline-block shadow-sm mb-4 border border-blue-50"><Icons.Search className="w-8 h-8 text-blue-100" /></div>
                                <p className="text-[#1e3a8a]/40 text-sm font-bold">ไม่มีข้อมูลในระบบ</p>
                            </div>
                        ) : (
                            filteredCustomers.map((customer, index) => (
                                <div key={customer.id} onClick={() => handleEdit(customer)} className="group bg-white rounded-2xl p-4 shadow-[0_4px_20px_-4px_rgba(30,58,138,0.08)] border border-gray-100 flex gap-4 items-center relative overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-1 cursor-pointer active:scale-[0.98] animate-fade-in-up opacity-0" style={{ animationDelay: `${(index * 100) + 300}ms` }}>
                                    <div className="absolute left-0 top-4 bottom-4 w-1.5 bg-gradient-to-b from-orange-400 to-orange-500 rounded-r-full shadow-sm group-hover:scale-y-110 transition-transform duration-300"></div>
                                    <div className="w-18 h-18 bg-blue-50/50 rounded-xl flex-shrink-0 overflow-hidden border border-blue-100/50 relative shadow-inner w-[72px] h-[72px] group-hover:shadow-md transition-shadow">
                                        {customer.image ? <img src={getDisplayImageUrl(customer.image)} alt="Color" className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" /> : <div className="w-full h-full flex flex-col items-center justify-center text-blue-200"><Icons.ImageIcon className="w-6 h-6 opacity-40 group-hover:opacity-60 transition-opacity" /></div>}
                                    </div>
                                    <div className="flex-1 min-w-0 pl-1">
                                        <h3 className="font-bold text-[#1e3a8a] text-[15px] truncate leading-tight mb-1 group-hover:text-orange-600 transition-colors duration-300">{customer.name}</h3>
                                        <div className="flex items-center text-[#1e3a8a]/70 text-xs mb-2 font-medium">
                                            <Icons.Phone className="w-3.5 h-3.5 mr-1.5 text-orange-500" /> <span className="tracking-wide">{customer.phone}</span>
                                        </div>
                                        <div className="flex items-center justify-between mt-1 pt-1 border-t border-blue-50/50">
                                            <span className="bg-[#1e3a8a] text-white px-2 py-0.5 rounded-md text-[9px] font-bold tracking-wider uppercase">{customer.technician || 'ทั่วไป'}</span>
                                            <span className="text-[10px] text-blue-300 font-bold flex items-center gap-2">
                                                {customer.date}
                                                <button onClick={(e) => handleDelete(customer.id, e)} className="p-1.5 rounded-full text-red-300 hover:text-red-500 hover:bg-red-50 transition-colors z-20 hover:scale-110 active:scale-95"><Icons.Trash2 className="w-4 h-4" /></button>
                                            </span>
                                        </div>
                                    </div>
                                    <Icons.ChevronRight className="text-blue-100 w-5 h-5 group-hover:text-orange-500 group-hover:translate-x-1 transition-all duration-300" />
                                </div>
                            ))
                        )}
                    </div>

                    {/* FAB */}
                    <div className="fixed bottom-6 left-0 w-full px-6 z-20 pointer-events-none flex justify-center animate-pop-in opacity-0" style={{ animationDelay: '600ms' }}>
                        <div className="animate-float">
                            <button onClick={handleAddNew} className="pointer-events-auto flex items-center gap-3 bg-[#1e3a8a] text-white px-8 py-4 rounded-full shadow-2xl shadow-blue-900/40 hover:bg-[#152c6e] active:scale-95 transition-all transform hover:-translate-y-1 ring-4 ring-white/10 group">
                                <div className="bg-orange-500 p-1 rounded-full shadow-inner group-hover:rotate-90 transition-transform duration-300"><Icons.Plus className="w-4 h-4 text-white" /></div>
                                <span className="font-bold text-sm tracking-widest uppercase">เพิ่มลูกค้าใหม่</span>
                            </button>
                        </div>
                    </div>

                    {/* Quota Warning Modal */}
                    {showQuotaWarning && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-[#1e3a8a]/60 backdrop-blur-md transition-all animate-in fade-in p-6" onClick={() => setShowQuotaWarning(false)}>
                            <div className="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl animate-pop-in text-center" onClick={e => e.stopPropagation()}>
                                <div className="w-20 h-20 bg-red-50 rounded-full mx-auto flex items-center justify-center mb-6">
                                    <Icons.Crown className="w-10 h-10 text-red-500" />
                                </div>
                                <h3 className="text-xl font-black text-[#1e3a8a] mb-2">โควต้าของคุณเต็มแล้ว</h3>
                                <p className="text-sm text-blue-400 font-medium mb-6">คุณใช้งานครบ {currentPackage.limit} รายการตามแพ็กเกจ <span className="font-bold text-orange-500">{currentPackage.name}</span> แล้ว กรุณาอัปเกรดเพื่อเพิ่มข้อมูลต่อ</p>
                                <button onClick={() => setShowQuotaWarning(false)} className="w-full bg-[#1e3a8a] text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-[#172554] active:scale-95 transition-all">
                                    ตกลง / ปิด
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Editor Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-[#1e3a8a]/60 backdrop-blur-sm transition-all duration-300" onClick={(e) => { if (e.target === e.currentTarget && !isSaving) { setIsModalOpen(false); setIsCameraActive(false); } }}>
                            <div className="bg-white w-full sm:max-w-md h-[94vh] sm:h-auto sm:max-h-[90vh] rounded-t-[40px] sm:rounded-3xl flex flex-col overflow-hidden shadow-2xl relative animate-pop-in opacity-0" style={{ animationDelay: '50ms' }}>
                                
                                {/* Camera Overlay */}
                                {isCameraActive && (
                                    <div className="absolute inset-0 z-50 bg-black flex flex-col animate-pop-in">
                                        <div className="relative flex-1 overflow-hidden bg-black flex items-center justify-center">
                                            {cameraError ? (
                                                <div className="text-white text-center p-6 space-y-4 flex flex-col items-center w-full animate-fade-in-up">
                                                    <div className="bg-red-500/20 p-4 rounded-full inline-block animate-pulse"><Icons.X className="w-10 h-10 text-red-400" /></div>
                                                    <p className="text-lg font-bold">{cameraError}</p>
                                                    <div className="flex flex-col gap-3 w-full max-w-xs mt-4">
                                                        <button onClick={triggerNativeCamera} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-500 shadow-lg flex items-center justify-center gap-2"><Icons.Camera className="w-4 h-4" /> ใช้กล้องระบบ (Native)</button>
                                                        <button onClick={() => { setIsCameraActive(false); triggerGallery(); }} className="px-6 py-3 bg-white/10 text-white border border-white/20 rounded-xl font-bold text-sm hover:bg-white/20 backdrop-blur-sm">เลือกจากอัลบั้ม</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <>
                                                    <video ref={videoRef} autoPlay playsInline muted className="absolute inset-0 w-full h-full object-cover"></video>
                                                    <canvas ref={canvasRef} className="hidden"></canvas>
                                                    <div className="absolute inset-0 pointer-events-none border border-white/20 m-4 rounded-xl"><div className="w-full h-1/3 border-b border-white/10"></div><div className="w-full h-1/3 border-b border-white/10"></div></div>
                                                </>
                                            )}
                                        </div>
                                        <div className="bg-black/80 backdrop-blur-lg p-6 pb-8 flex items-center justify-between">
                                            <button onClick={() => setIsCameraActive(false)} className="p-3 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all"><Icons.X className="w-6 h-6" /></button>
                                            {!cameraError && <button onClick={capturePhoto} className="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-transparent camera-btn-pulse active:scale-90 transition-transform"><div className="w-12 h-12 bg-white rounded-full"></div></button>}
                                            <button onClick={toggleCameraFacing} className="p-3 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all"><Icons.SwitchCamera className="w-6 h-6" /></button>
                                        </div>
                                    </div>
                                )}

                                {/* Modal Header */}
                                <div className="bg-white text-[#1e3a8a] p-8 pb-4 rounded-b-3xl z-10 relative shadow-sm">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h2 className="text-2xl font-black tracking-tight">{editingId ? 'แก้ไขข้อมูล' : 'เพิ่มข้อมูลใหม่'}</h2>
                                            <p className="text-blue-300 text-xs font-bold uppercase mt-1 tracking-widest">Customer Details & Formula</p>
                                        </div>
                                        <button onClick={() => !isSaving && setIsModalOpen(false)} className="bg-blue-50 p-2.5 rounded-full hover:bg-red-50 hover:text-red-500 hover:scale-110 text-blue-400 transition-all"><Icons.X className="w-6 h-6" /></button>
                                    </div>
                                </div>

                                <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-8 space-y-7 bg-white no-scrollbar">
                                    <div className="bg-blue-50/30 p-5 rounded-3xl border-2 border-blue-50 border-dashed hover:border-orange-200 transition-colors">
                                        <div className="flex justify-between items-center mb-4 px-1">
                                            <label className="text-xs font-black text-[#1e3a8a] uppercase tracking-widest">สูตรสี / ข้อมูลภาพ</label>
                                            {selectedImage && <span className="text-[10px] text-orange-600 font-black bg-orange-50 px-2 py-1 rounded-lg">UPLOADED</span>}
                                        </div>
                                        {selectedImage ? (
                                            <div className="relative rounded-2xl overflow-hidden shadow-xl border-4 border-white group">
                                                <img src={getDisplayImageUrl(selectedImage)} alt="Preview" className="w-full h-56 object-cover" />
                                                <div className="absolute inset-0 bg-[#1e3a8a]/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-[2px]">
                                                    <button type="button" disabled={isSaving} className="bg-white p-3 rounded-full text-red-500 shadow-xl hover:scale-110 active:scale-90 transition-transform" onClick={() => setSelectedImage(null)}><Icons.Trash2 className="w-6 h-6" /></button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 gap-4">
                                                <button type="button" disabled={isSaving} onClick={triggerNativeCamera} className="group flex flex-col items-center justify-center gap-3 py-8 bg-white border border-blue-100 rounded-3xl text-[#1e3a8a] shadow-sm hover:shadow-md hover:border-orange-200 active:scale-95 transition-all"><div className="p-3 bg-blue-50 rounded-2xl group-hover:bg-orange-50 group-hover:scale-110 transition-all"><Icons.Camera className="w-8 h-8 text-[#1e3a8a] group-hover:text-orange-500" /></div><span className="text-xs font-black text-[#1e3a8a] uppercase tracking-widest">ถ่ายรูป</span></button>
                                                <button type="button" disabled={isSaving} onClick={triggerGallery} className="group flex flex-col items-center justify-center gap-3 py-8 bg-white border border-blue-100 rounded-3xl text-[#1e3a8a] shadow-sm hover:shadow-md hover:border-orange-200 active:scale-95 transition-all"><div className="p-3 bg-blue-50 rounded-2xl group-hover:bg-orange-50 group-hover:scale-110 transition-all"><Icons.ImageIcon className="w-8 h-8 text-[#1e3a8a] group-hover:text-orange-500" /></div><span className="text-xs font-black text-[#1e3a8a] uppercase tracking-widest">อัลบั้ม</span></button>
                                            </div>
                                        )}
                                        <input type="file" ref={galleryInputRef} accept="image/*" onChange={handleImageUpload} className="hidden" />
                                        <input type="file" ref={nativeCameraInputRef} accept="image/jpeg, image/png, image/jpg" capture="environment" onChange={handleImageUpload} className="hidden" />
                                    </div>

                                    <div className="space-y-6">
                                        <div className="flex items-center border-2 border-blue-50 bg-blue-50/20 rounded-2xl px-5 py-4 focus-within:ring-2 focus-within:ring-[#1e3a8a] focus-within:bg-white transition-all shadow-sm">
                                            <Icons.User className="text-[#1e3a8a] w-6 h-6 mr-4 opacity-70" />
                                            <div className="flex-1">
                                                <label className="block text-xs font-black uppercase mb-1 tracking-widest text-[#1e3a8a] opacity-60">ชื่อลูกค้า</label>
                                                <input required type="text" disabled={isSaving} className="w-full outline-none text-[#1e3a8a] placeholder-blue-200 text-lg font-bold bg-transparent" placeholder="คุณสมชาย..." value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="flex items-center border-2 border-blue-50 bg-blue-50/20 rounded-2xl px-5 py-4 focus-within:ring-2 focus-within:ring-[#1e3a8a] focus-within:bg-white transition-all shadow-sm">
                                            <Icons.Phone className="text-orange-500 w-6 h-6 mr-4 opacity-70" />
                                            <div className="flex-1">
                                                <label className="block text-xs font-black uppercase mb-1 tracking-widest text-orange-500 opacity-60">เบอร์โทร</label>
                                                <input required type="tel" disabled={isSaving} className="w-full outline-none text-[#1e3a8a] placeholder-blue-200 text-lg font-bold bg-transparent" placeholder="08X-XXX-XXXX" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="flex items-center border-2 border-blue-50 bg-blue-50/20 rounded-2xl px-5 py-4 focus-within:ring-2 focus-within:ring-[#1e3a8a] focus-within:bg-white transition-all shadow-sm">
                                            <Icons.Brush className="text-[#1e3a8a] w-6 h-6 mr-4 opacity-70" />
                                            <div className="flex-1">
                                                <label className="block text-xs font-black uppercase mb-1 tracking-widest text-[#1e3a8a] opacity-60">ช่างผู้รับเหมา</label>
                                                <input type="text" disabled={isSaving} className="w-full outline-none text-[#1e3a8a] placeholder-blue-200 text-lg font-bold bg-transparent" placeholder="ชื่อช่างสี (ถ้ามี)" value={formData.technician} onChange={e => setFormData({...formData, technician: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="border-2 border-blue-50 bg-blue-50/20 rounded-2xl px-5 py-4 focus-within:ring-2 focus-within:ring-[#1e3a8a] focus-within:bg-white transition-all shadow-sm">
                                            <label className="block text-xs font-black text-[#1e3a8a] uppercase mb-2 tracking-widest opacity-60">รายละเอียดเพิ่มเติม / สูตรสี</label>
                                            <textarea rows="4" disabled={isSaving} className="w-full outline-none text-[#1e3a8a] placeholder-blue-200 text-base font-bold bg-transparent resize-none leading-relaxed" placeholder="ยี่ห้อรถ, รหัสสี..." value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} />
                                        </div>
                                    </div>
                                </form>

                                <div className="p-6 bg-white border-t border-blue-50">
                                    <button 
                                        onClick={handleSubmit} 
                                        disabled={isSaving}
                                        className={`w-full bg-gradient-to-r from-[#1e3a8a] to-[#2563eb] border-b-[6px] border-[#172554] text-white font-black py-4 rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3 text-lg tracking-[0.2em] uppercase relative overflow-hidden group ${isSaving ? 'opacity-80 cursor-not-allowed' : 'active:border-b-0 active:translate-y-[6px] hover:shadow-2xl'}`}
                                    >
                                        {!isSaving && <div className="absolute top-0 -left-[100%] w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent transform -skew-x-12 group-hover:animate-shine transition-all duration-1000"></div>}
                                        {isSaving ? (
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin relative z-10"></div>
                                        ) : (
                                            <Icons.Save className="w-6 h-6 relative z-10 group-hover:scale-110 transition-transform" /> 
                                        )}
                                        <span className="relative z-10">{isSaving ? 'กำลังบันทึก...' : (editingId ? 'บันทึกการแก้ไข' : 'บันทึกข้อมูลลูกค้า')}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Root Component (App Switcher) ---
        const AppRoot = () => {
            const [currentUser, setCurrentUser] = useState(() => {
                const saved = localStorage.getItem('paintShopCurrentUser');
                return saved ? JSON.parse(saved) : null;
            });

            const handleLogin = (user) => {
                setCurrentUser(user);
                localStorage.setItem('paintShopCurrentUser', JSON.stringify(user));
            };

            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem('paintShopCurrentUser');
            };

            if (currentUser) {
                if (currentUser.role === 'ADMIN') {
                    return <AdminDashboard currentUser={currentUser} onLogout={handleLogout} />;
                }
                return <Dashboard currentUser={currentUser} onLogout={handleLogout} />;
            }
            return <AuthScreen onLogin={handleLogin} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppRoot />);
    </script>
</body>
</html>
